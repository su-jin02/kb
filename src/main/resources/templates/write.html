<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Write</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/reset-css@5.0.1/reset.min.css" />
  <link rel="stylesheet" type="text/css" th:href="@{/css/board-write.css}" />
  <link rel="stylesheet" type="text/css" href="/css/board-write.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.8/dist/web/static/pretendard-dynamic-subset.css" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js" integrity="sha512-894YE6QWD5I59HgZOGReFYm4dnWc1Qt5NtvYSaNcOP+u1T9qYdvdihz0PPSiiqn/+/3e7Jo4EaG7TubfWGUrMQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script>
    var resultData; // 전역 변수로 선언하여 첫 번째 함수의 결과를 저장

    function submitForm1(event) {
      event.preventDefault();
      var button1 = document.getElementById('submit1');
      button1.style.backgroundColor = 'gray'; // 클릭 시 회색으로 변경
      var formData = {
        house: document.getElementById('house').value,
        now: document.getElementById('now').value,
        time: document.getElementById('time').value,
        preference: document.getElementById('preference').value,
        living: document.getElementById('living').value
      };

      fetch('/get-data', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
      })
              .then(response => response.json())
              .then(data => {
                // 결과 데이터를 디버그 출력
                console.log(data);
                // 기본 결과 처리
                document.getElementById('result').innerText = data.result;
                document.getElementById('hiddenField').value = data.result;
                resultData = data.result; // 결과값을 전역 변수에 저장

                // 추가된 데이터 표시
                var additionalResultsContainer = document.getElementById('additional-results');
                additionalResultsContainer.innerHTML = ''; // 기존 내용을 초기화
                // KB증권 상품 추천 제목 추가
                var kbTitle = document.createElement('div');
                kbTitle.innerText = 'KB증권 상품 추천';
                kbTitle.style.fontSize = '24px'; // 제목 글씨 크기 설정
                kbTitle.style.fontWeight = 'bold';
                additionalResultsContainer.appendChild(kbTitle);

                for (const key in data) {
                  if (data.hasOwnProperty(key) && key !== 'result') {
                    var resultDiv = document.createElement('div');
                    resultDiv.innerText = `${key}: ${data[key]}`;
                    resultDiv.style.color = '#776051'; // 추가된 데이터 텍스트 색상 변경
                    resultDiv.style.fontSize = '18px';
                    additionalResultsContainer.appendChild(resultDiv);
                  }
                }
                button1.style.backgroundColor = '#F7B401'; // 완료 시 노란색으로 변경
              })
              .catch(error => {
                console.error('Error:', error);
                button1.style.backgroundColor = '#F7B401'; // 에러 시에도 노란색으로 변경
              });
    }

    function submitForm2(event) {
      event.preventDefault();
      var button2 = document.getElementById('submit2');
      button2.style.backgroundColor = 'gray'; // 클릭 시 회색으로 변경
      var formData = {
        house: document.getElementById('house').value,
        now: document.getElementById('now').value,
        time: document.getElementById('time').value,
        preference: document.getElementById('preference').value,
        living: document.getElementById('living').value,
        gpt: resultData // 첫 번째 함수의 결과값을 gpt 필드에 저장
      };

      fetch('/board/write', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
      })
              .then(response => {
                if (response.ok) {
                  window.location.href = '/'; // 성공적으로 완료되면 리다이렉트
                } else {
                  button2.style.backgroundColor = '#F7B401'; // 에러 시 노란색으로 변경
                }
              })
              .catch(error => {
                console.error('Error:', error);
                button2.style.backgroundColor = '#F7B401'; // 에러 시 노란색으로 변경
              });
    }
  </script>
</head>

<body>
<!-- 헤더는 나중에 js로 연결하기 -->
<header class="header">
  <a href="/"><img class="back list_icon" src="/img/backicon.svg" alt="뒤로가기"></a>
  <img class="prism list_icon2" src="/img/kb.png" alt="로고" id="logo">
  <input class="menu-btn" type="checkbox" id="menu-btn" />
  <label class='menu-icon' for="menu-btn" onclick="toggle()">
    <div class='menu-button'>
      <img src="/img/hamburger.svg" alt="로고" class="Group 1_pink">
    </div>
  </label>
</header>
<form id="dynamicForm" method="POST" enctype="multipart/form-data">
  {% csrf_token %}
  <div class="container_main" id="blur">
    <main>
      <div id="wrap">
        <div id="title">
          <div class="title_photo">
            <img src="/img/staricon.svg"></img>
          </div>
          <div class="title_tx">내 집 마련하기</div>
        </div>
        <div class="container">
          <div class="title_ex">마이데이터를 입력해주세요 :)</div>
          <div class="label_wrap">
            <label for="house">꿈의 집</label>
          </div>
          <input type="text" id="house" name="house"
                 maxlength="20" minlength="4" placeholder="꿈의 집을 입력해주세요"/>
          <div class="label_wrap">
            <label for="now">현재 자금</label>
          </div>
          <input type="text" id="now" name="now"
                 maxlength="20" minlength="4" placeholder="현재 자금을 입력해주세요"/>
          <div class="label_wrap">
            <label for="time">목표 년수</label>
          </div>
          <input type="text" id="time" name="time"
                 maxlength="4" minlength="4" placeholder="목표 년수를 입력해주세요"/>

          <div class="label_wrap">
            <label for="preference">투자 성향</label>
          </div>
          <input type="text" id="preference" name="preference"
                 maxlength="20" minlength="1" placeholder="Conservative / Moderate / Aggressive / Balanced"/>
          <div class="label_wrap">
            <label for="living">매달 생활비</label>
          </div>
          <input type="text" id="living" name="living"
                 maxlength="20" minlength="4" placeholder="매달 생활비를 입력해주세요"/>
          <input type="button" id="submit1" value="포토폴리오 생성" onclick="submitForm1(event)" style="background-color: #F7B401;">
          <div class="caution" id="result">
            <div>* 포토폴리오를 짜드립니다.</div>
          </div>
          <div id="additional-results"></div> <!-- 추가된 데이터 표시 -->
          <input type="hidden" id="hiddenField" name="hiddenData" />
          <input type="submit" id="submit2" value="결과 업로드" onclick="submitForm2(event)" style="background-color: #F7B401;">
        </div>
      </div>
    </main>
  </div>
</form>
</body>
</html>
